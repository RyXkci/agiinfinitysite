<canvas id="canvasTorus"></canvas>
<script>
  import * as THREE from "three";
  import { OrbitControls } from "three/addons/controls/OrbitControls.js";
  import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";

  import { gsap } from "gsap";

  import { ScrollTrigger } from "gsap/ScrollTrigger";
  gsap.registerPlugin(ScrollTrigger);

  // Check for mobile/touch devices
  const isMobile =
    /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
      navigator.userAgent
    ) ||
    window.innerWidth <= 1024 ||
    "ontouchstart" in window;

  // if (isMobile) {
  //   ScrollTrigger.normalizeScroll(true);
  // }
  //

  // BEGIN 3d CANVAS STUFF

  const torusCanvas:HTMLCanvasElement = document.querySelector("#canvasTorus")!;
  // create scene
  const scene = new THREE.Scene();

  // camera
  const camera = new THREE.PerspectiveCamera(
    75,
    window.innerWidth / window.innerHeight,
    0.1,
    1000
  );

  camera.position.z = 4;

  let torus;
  let mixer;
  const loader = new GLTFLoader();
  loader.load(
    "/models/torus.glb",
    function (gltf) {
      torus = gltf.scene;
      console.log("TORUS", torus);
      scene.add(torus);

      // Move to right and rotate on scroller-three
      // Move to right and rotate on scroller-three
      gsap.to(torus.rotation, {
        x: Math.PI * 0.5,
        duration: 4,
        scrollTrigger: {
          trigger: ".scroller-three",
          start: "top bottom",
          end: "bottom top",
          scrub: 1,
          toggleActions: "play none none reverse",
        },
      });

      gsap.to(torus.position, {
        x: 4,
        duration: 4,

        scrollTrigger: {
          trigger: ".scroller-three",
          start: "top bottom",
          end: "bottom top",
          scrub: 1,
          toggleActions: "play none none reverse",
        },
      });

      // Move back to center and top on partner-section
      gsap.to(torus.position, {
        x: 0,
        y: 1,
        duration: 4,
        immediateRender: false,
        scrollTrigger: {
          trigger: ".info-list",
          start: "top bottom",
          end: "top top",
          scrub: 1,
          toggleActions: "play none none reverse",
        },
      });

      gsap.to(torus.rotation, {
        x: 0,
        duration: 4,
        ease: "power1.out",
        immediateRender: false,
        scrollTrigger: {
          trigger: ".partner-section",
          start: "top bottom",
          end: "top top",
          // scrub: 1,
          toggleActions: "play none none reverse",
        },
      });

      // ZOOM

      // gsap.to(camera.position, {
      //   z: 2,
      //   duration: 4,
      //   scrollTrigger: {
      //     trigger: ".scroller-four",
      //     start: "top bottom",
      //     end: "bottom top",
      //     scrub: 1,
      //     onEnter: () => {
      //       mixer.clipAction(gltf.animations[0]).stop(); // Stop animation
      //     },
      //     onLeaveBack: () => {
      //       mixer.clipAction(gltf.animations[0]).play(); // Resume when scrolling back up
      //     },
      //   },
      // });

      // gsap.to(torus.position, {
      //   x: 0,
      //   y: 0,
      //   duration: 4,
      //   scrollTrigger: {
      //     trigger: ".scroller-four",
      //     start: "top bottom",
      //     end: "bottom top",
      //     scrub: 1,
      //   },
      // });

      // Change the color of all meshes in the model
      torus.traverse((child) => {
        if (child.isMesh) {
          console.log(child);
          // Option 1: Replace material with a new colored material
          child.material = new THREE.MeshStandardMaterial({
            color: 0x98fefe, // Your custom magenta/pink color
            metalness: 0.3,
            roughness: 0.4,
          });

          // Option 2: If you want to keep existing material properties and just change color
          // Uncomment this instead of Option 1
          // if (child.material) {
          //   child.material.color.setHex(0x00ff00); // Green
          // }
        }
      });

      mixer = new THREE.AnimationMixer(torus);
      mixer.clipAction(gltf.animations[0]).play();
    },
    function (xhr) {},
    function (error) {}
  );

  const renderer = new THREE.WebGLRenderer({
    canvas: torusCanvas,
    alpha: true,
  });
  renderer.setSize(window.innerWidth, window.innerHeight);
  window.addEventListener("resize", () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  });

  const controls = new OrbitControls(camera, torusCanvas);
  controls.enableDamping = true;
  // controls.autoRotate = true;
  const reRenderer3d = () => {
    renderer.render(scene, camera);
    requestAnimationFrame(reRenderer3d);
    if (mixer) mixer.update(0.02);
    controls.update();
  };

  const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
  scene.add(ambientLight);

  const topLight = new THREE.DirectionalLight(0xffffff, 1);
  topLight.position.set(500, 500, 500);
  scene.add(topLight);
  reRenderer3d();

  const autoRotateObserver = new IntersectionObserver(
  (entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        // User has scrolled to second section
        console.log("rotator has entered");
        controls.autoRotate = false;
      } else {
        // User scrolled back up
        // controls.autoRotate = true;
      }
    });
  },
  {
    threshold: 0.1, // Adjust based on when you want the transition
  }
);

const rotateObserver = document.querySelector(".scroller-three");

autoRotateObserver.observe(rotateObserver);
</script>
